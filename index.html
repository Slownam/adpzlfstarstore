<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin Panel — DB Manager (WORKING)</title>
<style>
  body{font-family:Inter,Arial,system-ui;background:#0b1220;color:#e6eef8;padding:18px}
  .wrap{max-width:1000px;margin:0 auto}
  .card{background:#0f172a;padding:16px;border-radius:12px}
  input,textarea,button{padding:8px;border-radius:8px;border:1px solid #1f2937;background:transparent;color:#e6eef8;width:100%}
  .row{display:grid;grid-template-columns:1fr 220px;gap:10px}
  .list{background:#07102a;padding:8px;border-radius:8px;margin-top:10px;max-height:360px;overflow:auto}
  .btn{background:#7c3aed;color:white;padding:8px;border-radius:8px;border:0;cursor:pointer}
  .muted{color:#94a3b8}
  pre{white-space:pre-wrap;background:#07102a;padding:10px;border-radius:8px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h2>Admin Panel — DB Manager</h2>
    <p class="muted">DB repo info telah diisi otomatis sesuai data yang diberikan.</p>

    <div class="row">
      <input id="owner" placeholder="DB owner (username/org)" value="Slownam" />
      <input id="repo" placeholder="DB repo name" value="databsepanel" />
    </div>
    <div class="row" style="margin-top:8px">
      <input id="path" placeholder="Path to database.json (eg: database.json)" value="database.json" />
      <input id="branch" placeholder="Branch (main)" value="main" />
    </div>
    <div style="margin-top:8px;display:flex;gap:8px">
      <input id="token" placeholder="GitHub token (fine-grained)" value="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" />
      <button id="saveBtn" class="btn">Save & Load DB</button>
    </div>

    <div style="margin-top:12px;display:flex;gap:8px">
      <input id="codeName" placeholder="Nama penerima (optional)" />
      <button id="genCodeBtn" class="btn">Generate 1 Kode</button>
      <button id="editDbBtn" class="btn" style="background:#111827">Edit Database</button>
      <button id="exportBtn" class="btn" style="background:#111827">Export JSON</button>
    </div>

    <div id="status" class="muted" style="margin-top:8px"></div>

    <h3 style="margin-top:12px">Database preview</h3>
    <div id="dbView" class="list"><div class="muted">DB belum dimuat</div></div>

    <div id="editorWrap" style="display:none;margin-top:12px">
      <h4>Edit database.json</h4>
      <textarea id="dbEditor" rows="14" style="width:100%"></textarea>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="saveDbBtn" class="btn">Save DB</button>
        <button id="cancelEdit" class="btn" style="background:#111827">Cancel</button>
      </div>
    </div>
  </div>
</div>

<script>
function b64enc(s){ return btoa(unescape(encodeURIComponent(s))); }
function b64dec(b){ try{ return decodeURIComponent(escape(atob(b))); }catch(e){ return atob(b); } }
const API_BASE = 'https://api.github.com/repos';

let currentDB = null;
let currentSha = null;
let cfg = { owner:'Slownam', repo:'databsepanel', path:'database.json', branch:'main', token:'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' };

function setStatus(t){ document.getElementById('status').textContent = t; }

async function ghGet(owner, repo, path, token){
  const url = `${API_BASE}/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
  const res = await fetch(url, { headers: { 'Authorization':'token '+token, 'Accept':'application/vnd.github.v3+json' }});
  if(res.status === 404) return null;
  if(!res.ok) throw new Error('GitHub GET error: ' + res.status + ' ' + await res.text());
  return await res.json();
}
async function ghPut(owner, repo, path, contentB64, message, sha, token, branch){
  const url = `${API_BASE}/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
  const body = { message, content: contentB64, branch };
  if(sha) body.sha = sha;
  const res = await fetch(url, { method:'PUT', headers:{ 'Authorization':'token '+token, 'Accept':'application/vnd.github.v3+json', 'Content-Type':'application/json' }, body: JSON.stringify(body) });
  if(!res.ok) throw new Error('GitHub PUT error: ' + res.status + ' ' + await res.text());
  return await res.json();
}

function genCode(){
  const chars = 'abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
  let s = 'lf';
  for(let i=0;i<5;i++) s += chars.charAt(Math.floor(Math.random()*chars.length));
  return s;
}

async function loadDb(){
  try{
    setStatus('Loading DB...');
    const file = await ghGet(cfg.owner, cfg.repo, cfg.path, cfg.token);
    if(!file){
      currentDB = { codes: [], accounts: [] };
      currentSha = null;
      setStatus('DB tidak ditemukan — akan dibuat pada save.');
    } else {
      currentSha = file.sha;
      currentDB = JSON.parse(b64dec(file.content.replace(/\n/g,'')));
      currentDB.codes = currentDB.codes || [];
      currentDB.accounts = currentDB.accounts || [];
      setStatus(`Loaded DB — codes: ${currentDB.codes.length}, accounts: ${currentDB.accounts.length}`);
    }
    renderDbView();
  }catch(err){
    setStatus('Error load DB: '+err.message);
    console.error(err);
  }
}

function renderDbView(){
  const wrap = document.getElementById('dbView'); wrap.innerHTML = '';
  if(!currentDB){ wrap.innerHTML = '<div class="muted">DB belum dimuat</div>'; return; }
  const codes = (currentDB.codes||[]).slice().reverse();
  const accounts = (currentDB.accounts||[]).slice().reverse();

  const left = document.createElement('div'); left.style.marginBottom='8px';
  left.innerHTML = `<div style="font-weight:700">Codes (${codes.length})</div>`;
  codes.forEach(c=>{
    const d = document.createElement('div'); d.style.padding='6px 0'; d.innerHTML = `<strong>${c.code}</strong> ${c.used?'<span style="color:#fca5a5">(used)</span>':''} <div class="muted">for: ${c.name||'-'} • ${c.created_at||''}</div>`;
    left.appendChild(d);
  });

  const right = document.createElement('div');
  right.innerHTML = `<div style="font-weight:700;margin-top:8px">Accounts (${accounts.length})</div>`;
  accounts.forEach(a=>{
    const d = document.createElement('div'); d.style.padding='6px 0'; d.innerHTML = `<strong>${a.name || '-'}</strong> <div class="muted">${a.email||'-'} • ${a.wa||'-'} • Exp: ${a.expires_at||'-'}</div>`;
    right.appendChild(d);
  });

  const container = document.createElement('div'); container.style.display='grid'; container.style.gridTemplateColumns='1fr 1fr'; container.style.gap='12px';
  container.appendChild(left); container.appendChild(right);
  wrap.appendChild(container);
}

// UI bind
document.getElementById('saveBtn').addEventListener('click', ()=>{
  const owner = document.getElementById('owner').value.trim();
  const repo  = document.getElementById('repo').value.trim();
  const path  = document.getElementById('path').value.trim() || 'database.json';
  const branch= document.getElementById('branch').value.trim() || 'main';
  const token = document.getElementById('token').value.trim();
  if(!owner||!repo||!token) { alert('Isi owner, repo, token'); return; }
  cfg = { owner, repo, path, branch, token };
  localStorage.setItem('admin_db_cfg', JSON.stringify(cfg));
  loadDb();
});

document.getElementById('genCodeBtn').addEventListener('click', async ()=>{
  try{
    if(!cfg.token) throw new Error('Load DB config dulu (Save & Load DB).');
    const name = document.getElementById('codeName').value.trim();
    if(!currentDB) await loadDb();
    let code; let attempts=0;
    do { code = genCode(); attempts++; if(attempts>30) throw new Error('Gagal generate kode unik'); } while((currentDB.codes||[]).some(x=>x.code===code));
    currentDB.codes = currentDB.codes || [];
    currentDB.codes.push({ code, name: name || '', created_at: new Date().toISOString(), used:false });
    const content = b64enc(JSON.stringify(currentDB, null, 2));
    const res = await ghPut(cfg.owner, cfg.repo, cfg.path, content, 'Generate code ' + code, currentSha, cfg.token, cfg.branch);
    currentSha = res.content.sha;
    await loadDb();
    alert('Kode dibuat: ' + code);
  }catch(err){ alert('Error: ' + err.message); console.error(err); }
});

document.getElementById('editDbBtn').addEventListener('click', ()=>{
  if(!currentDB){ alert('Load DB dulu'); return; }
  document.getElementById('editorWrap').style.display = 'block';
  document.getElementById('dbEditor').value = JSON.stringify(currentDB, null, 2);
});

document.getElementById('cancelEdit').addEventListener('click', ()=>{ document.getElementById('editorWrap').style.display='none'; });

document.getElementById('saveDbBtn').addEventListener('click', async ()=>{
  try{
    const text = document.getElementById('dbEditor').value;
    const parsed = JSON.parse(text);
    const content = b64enc(JSON.stringify(parsed, null, 2));
    const res = await ghPut(cfg.owner, cfg.repo, cfg.path, content, 'Manual edit DB via admin', currentSha, cfg.token, cfg.branch);
    currentSha = res.content.sha;
    document.getElementById('editorWrap').style.display = 'none';
    await loadDb();
    alert('DB disimpan');
  }catch(err){ alert('Save error: ' + err.message); console.error(err); }
});

document.getElementById('exportBtn').addEventListener('click', ()=>{
  if(!currentDB){ alert('Load DB dulu'); return; }
  const blob = new Blob([JSON.stringify(currentDB, null, 2)], { type:'application/json' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'database.json'; a.click(); URL.revokeObjectURL(a.href);
});

// Try load saved cfg on load
window.addEventListener('load', ()=>{
  const saved = localStorage.getItem('admin_db_cfg');
  if(saved){
    try{ cfg = JSON.parse(saved); document.getElementById('owner').value = cfg.owner; document.getElementById('repo').value = cfg.repo; document.getElementById('path').value = cfg.path; document.getElementById('branch').value = cfg.branch || 'main'; document.getElementById('token').value = cfg.token; loadDb(); }catch(e){ console.warn(e); }
  } else {
    // auto-load the prefilled cfg we set at top
    document.getElementById('owner').value = cfg.owner;
    document.getElementById('repo').value = cfg.repo;
    document.getElementById('path').value = cfg.path;
    document.getElementById('branch').value = cfg.branch;
    document.getElementById('token').value = cfg.token;
    // try auto load once
    loadDb().catch(()=>{});
  }
});
</script>
</body>
</html>